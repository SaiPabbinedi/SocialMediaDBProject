<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapTrend | Dashboard</title>
    <link rel="stylesheet" href="design.css">
    <script src="https://kit.fontawesome.com/8ba54eb703.js" crossorigin="anonymous"></script>
    <script src="autocomplete.js"></script>
</head>
<body>
    <label id="scrollLabel">
        <input id="scrollinput"  type="checkbox">
        <div class="toggle">
            <span class="top_line common"></span>
            <span class="middle_line common"></span>
            <span class="bottom_line common"></span>
        </div>
        <div class="slide">
            <h1>
                <img src="/vectoricons/at.svg" id="mail" alt="mail" height="35px" width="35px">
                Trend
            </h1>
            <div class="container">
                <div class="profile">
                    <!-- <img src="https://xsgames.co/randomusers/avatar.php?g=male" id= "image" alt="profile" height ="120px" width="120px"> -->
                    <img src="" id= "profile-image" alt="profile-picture" height ="120px" width="120px">
                </div>
                <div class="uname">
                    <img src="/vectoricons/user.svg" id="uname" alt="uname" height="20px" width="20px">
                    <img src="/vectoricons/at.svg" id="mail" alt="mail" height="20px" width="20px">
                    <p id="username"></p> 
                </div>
                <div class="mail">
                    <img src="/vectoricons/envelope.svg" id="mail" alt="mail" height="20px" width="20px">
                    <p id="email"></p>
                </div>
                <div class="interests">
                    <img src="/vectoricons/heart.svg" id="interests" alt="interests" height="20px" width="20px">
                    <p id="interest"></p>
                </div>
                <div class="birthday">
                    <img src="/vectoricons/birthday-cake.png" id="birthday" alt="birthday" height="20px" width="20px">
                    <p id="birthday-day"></p>
                </div>
                <div class="gender">
                    <img src="/vectoricons/gender.png" id="gender" alt="gender" height="20px" width="20px">
                    <p id="gender1"></p>
                </div>
                <div class="age">
                    <img src="/vectoricons/age.png" id="age" alt="age" height="20px" width="20px">
                    <p id="user-age"></p>
                </div>
                <div class="profilepage">
                    <button id="profilepagebtn" onclick="window.location.href='/profilepage.html'">
                        <img src="/vectoricons/user.svg" id="profilepage" alt="profilepage" height="20px" width="20px">
                        PROFILE PAGE
                    </button>
                </div>
                <div class="logout">
                    <button id="logoutbtn">
                        <img src="/vectoricons/logout.svg" id="logout" alt="logout" height="20px" width="20px">
                        LOGOUT
                    </button>
                </div>
            </div>
        </div>
    </label>
    <div class="trendsnap">
        <div class="dashboard">
            <header>
                <div class="logo">
                    <h1>SnapTrend</h1>
                </div>
                <div class="search">
                    <div class="searchmenu">
                        <input type="text" id="search-box" placeholder="Search Users" autocomplete="off">
                        <button class="btn-search"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                    <div class="result-box"></div>
                </div>
            </header>
            <main>
                <!-- <div class="uname">
                    <h4 id="username"></h4>
                </div> -->
                <div class="starttrend">
                    <img src="/vectoricons/edit.svg" id="starttrend" alt="starttrend" height="20px" width="20px">
                    <button id="starttrendbtn">
                        <h2>START A TREND</h2>
                    </button>
                </div>
                <div class="posttrendnew">
                    <div class="texttrend">
                        <label for="posttrend"></label>
                        <input type="text" id="posttrend" placeholder="Post a Trend">
                    </div>
                    <div class="trendpostbtndiv">
                        <button id="posttrendbtn">
                            <h2>TREND</h2>   
                        </button>
                    </div>
                </div>
                <!-- <div class="userposts">
                    <div class="userdetails">
                        <div class="profilepic">
                            <img src="/vectoricons/heart.svg" id= "image" alt="profile" height="25px" width="25px">
                        </div>
                        <div class="uname">
                            <p id="username">USERNAME GETS REPLACED HERE!</p>
                        </div>
                        <div class="date">
                            <p id="date">DATE GETS REPLACED HERE!</p>
                        </div>
                    </div>
                    <div class="post">
                        <p id="userpostdata">POST DATA GETS REPLACED HERE!</p>
                    </div>
                </div> -->
                <div class="userposts" id="userPostsContainer"></div>
            </main>
            <footer class="footer">
                <div class="downcontainer">
                    <div class="pageupbtn">
                        <button id="scrollUpBtn" onclick="scrollToTop()">
                            <img src="/vectoricons/angle-square-up.svg" id="up" alt="up" height="40px" width="40px">
                        </button>
                    </div>
                </div>
            </footer>
        </div>
        <hr>
        <div class="adboard">
            <h1>Check this one out</h1>
            <div class="ad">
                <img src="" id= "adimage" alt="Advertisement" height="600px" width="240px" >
            </div>
            <div class="sell">
                <button id="sellbtn">
                    <img src="/vectoricons/shopping-cart.png" id="sell" alt="sell" height="20px" width="20px">
                    <a href="" id="url-btn"></a>
                </button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var toggleSwitch = document.querySelector('input[type="checkbox"]');
            var mainContent = document.querySelector('.dashboard');
            var scrollLabel = document.getElementById('scrollLabel');
            var labelWidth = 20;
    
            toggleSwitch.addEventListener('change', function () {
                if (toggleSwitch.checked) {
                    mainContent.style.marginLeft = labelWidth + '%';
                } else {
                    mainContent.style.marginLeft = '0';
                }
            });
        });

        var scrollUpBtn = document.getElementById("scrollUpBtn");

        window.onscroll = function () {
            var scrollPosition = window.scrollY || document.documentElement.scrollTop;
            var pageHeight = window.innerHeight;
            var labelMargin = labelWidth * pageHeight / 100; // Calculate the label margin in pixels

            if (scrollPosition > pageHeight) {
                mainContent.style.marginLeft = '0'; // Reset margin to 0
                mainContent.style.width = '100%'; // Expand main content width to full page
                scrollUpBtn.style.display = "block";
            } else {
                mainContent.style.marginLeft = labelMargin + 'px'; // Set margin to label width
                mainContent.style.width = 'calc(100% - ' + labelMargin + 'px)'; // Adjust main content width
                scrollUpBtn.style.display = "none";
            }
        };

        function scrollToTop() {
            document.documentElement.scrollTop = 0;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const startTrendBtn = document.getElementById('starttrendbtn');
            const trendPostNewDiv = document.querySelector('.posttrendnew');
            const postTrendBtn = document.getElementById('posttrendbtn');
        
            startTrendBtn.addEventListener('click', function () {
                trendPostNewDiv.style.display = 'flex'; 
            });

            postTrendBtn.addEventListener('click', function () {
                trendPostNewDiv.style.display = 'none'; 
            }); 
        });

        document.addEventListener('DOMContentLoaded', () => {
            const storedUsername = sessionStorage.getItem('username');
            const usernameElements = document.querySelectorAll('.uname p#username');
            
            if (usernameElements.length > 0) {
                usernameElements.forEach((element) => {
                    //console.log('Updating Element Text Content:', element);
                    element.textContent = storedUsername;
                });
            } else {
                console.error('Elements with class "uname" and h4 tag with ID "username" not found on the dashboard page.');
            }
            
        
            const logoutBtn = document.getElementById('logoutbtn');
            logoutBtn.addEventListener('click', function () {
                sessionStorage.removeItem('username');
                window.location.href = './signin.html';
            });
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const storedUsername = sessionStorage.getItem('username');
            const userData = await fetchUserData(storedUsername);

            const profileImageElement = document.getElementById('profile-image');
            profileImageElement.src = `/${userData.picture_path}`;


        
            const usernameElements = document.querySelectorAll('.uname p#username');
            if (usernameElements.length > 0) {
                usernameElements.forEach((element) => {
                    element.textContent = storedUsername;
                });
            } else {
                console.error('Elements with class "uname" and p tag with ID "username" not found.');
            }
        
            const emailElement = document.getElementById('email');
            emailElement.textContent = userData.email || '';
        
            const interestsElement = document.getElementById('interest');
            interestsElement.textContent = userData.bio || '';

            const birthdayElement = document.getElementById('birthday-day');
            const ageElement = document.getElementById('user-age');
            const birthdayDate = new Date(userData.birthday);

            const today = new Date();
            const age = today.getFullYear() - birthdayDate.getFullYear();
            const isBirthdayPassed = today.getMonth() > birthdayDate.getMonth() || 
                    (today.getMonth() === birthdayDate.getMonth() && today.getDate() >= birthdayDate.getDate());

            const finalAge = isBirthdayPassed ? age : age - 1;

            const options = {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            };

            const formattedBirthday = birthdayDate.toLocaleDateString('en-US', options);
            const birthdayWithAge = `${formattedBirthday}`;

            birthdayElement.textContent = birthdayWithAge || '';
            ageElement.textContent = `Age: ${finalAge}`;


            const genderElement = document.getElementById('gender1');
            genderElement.textContent = userData.gender || '';

            const logoutBtn = document.getElementById('logoutbtn');
            logoutBtn.addEventListener('click', function () {
                sessionStorage.removeItem('username');
                window.location.href = './signin.html';
            });
        });


        document.addEventListener('DOMContentLoaded', function() {
            const postTrendBtn = document.getElementById('posttrendbtn');
        
            postTrendBtn.addEventListener('click', function() {
                // Get username from sessionStorage
                const username = sessionStorage.getItem('username');
                //alert(username);
                // Get post content from input field
                const postContent = document.getElementById('posttrend').value;
                
                const currentDate = new Date().toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                });

                // Make AJAX request to insert post
                fetch('http://localhost:5501/api/insertPost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, postContent, currentDate }),
                })
                .then(response => response.json())
                .then(data => {
                    // Handle the response as needed
                    console.log(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        
        async function fetchUserData(username) {
            try {
                const response = await fetch(`http://localhost:5501/api/getUserData?username=${username}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }
                const userData = await response.json();
                return userData;
            } catch (error) {
                console.error('Error fetching user data:', error);
                throw error;
            }
        }

        // Assuming this code runs in a browser environment

// Function to fetch ad data from the server
async function getAdData(advertiserID) {
    try {
      const response = await fetch('http://localhost:5501/api/getAdData', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ advertiser_id: advertiserID }),
      });
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
  
      const adData = await response.json();
      console.log('Ad Data:', adData);
      displayAdData(adData);
  
      // You can now use the adData in your frontend as needed
      // For example, update the UI with the received data
    } catch (error) {
      console.error('Error fetching ad data:', error);
      // Handle the error gracefully in your application
      
    }
  }
  
  // Example usage:
  //random funtion to generate integers in between a range
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
  getAdData(getRandomInt(5, 10));
  



        async function displayAdData(adData) {
            try {
                
        
                // Update HTML elements with the fetched data
                const adTitleElement = document.querySelector('.adboard h1');
                adTitleElement.textContent = adData.advertiser_name || '';
        
                const adImageElement = document.getElementById('adimage');
                adImageElement.src = `/${adData.adpicture_path}` || '';
                adImageElement.alt = 'Advertisement';
        
                const sellButtonElement = document.getElementById('sellbtn');
                const adLinkElement = document.getElementById('url-btn');
                adLinkElement.href = adData.url_link || '';
                adLinkElement.textContent = 'Buy Now';
        
            } catch (error) {
                console.error('Error displaying ad data:', error);
                // Handle the error as needed
            }
        }
        
        // Now call the displayAdData function to update HTML elements with advertisement data
        

        // Replace the existing fetch call with this code
document.addEventListener('DOMContentLoaded', () => {
    // Fetch 10 posts from the server
    fetch('http://localhost:5501/api/getTenPosts')
    .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
        .then(posts => {
        // Get the container element
        console.log(posts);
        const container = document.getElementById('userPostsContainer');
        // Iterate through the posts and create post cards
        posts.forEach(post => {
          // Create a new post card element
            const postCard = document.createElement('div');
            postCard.classList.add('userposts');

          // Add your existing HTML structure with placeholders replaced by actual data
        postCard.innerHTML = `
            <!-- Your existing HTML structure with placeholders replaced by actual data -->
            <div class="userdetails">
                <!-- <div class="profilepic">
                    <img src="${post.adpicture_path}" id= "profile-image" alt="profile-picture">
                </div> -->
                <!-- <div class="uname">
                    <p id="username">${post.username}</p>
                </div> -->
                <div class="date">
                    <p id="date">${post.created_at}</p>
                </div>
            </div>
            <div class="post">
                <p id="userpostdata">${post.content}</p>
            </div>
            `;
          // Append the post card to the container
            container.appendChild(postCard);
        });
        })
        .catch(error => console.error('Error fetching data:', error));
});

        
        
    </script>
    <!-- displayAdData(); -->
    <!-- document.addEventListener('DOMContentLoaded', function () {
        // Fetch advertisement data from the backend

        async function fetchAdData() {
            try {
                // Assuming the username is known or retrieved from somewhere
        const storedUsername = sessionStorage.getItem('username');

                const advertiser_name = storedUsername;
                alert('req sent');
                // Make an AJAX request to the backend
                const response = await fetch('http://localhost:5501/getAdData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ advertiser_name}),
                });
                alert(response);
                console.log(response);
                // Check if the response is successful (status code in the range 200-299)
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const adData = await response.json();
                console.log(adData);

                // Update HTML elements with the fetched data
                const adImageElement = document.getElementById('adimage');
                adImageElement.src = adData.adpicture_path || '';  // Update with your actual path

                const sellButtonElement = document.getElementById('sellbtn');
                const adLinkElement = document.getElementById('url-btn');
                sellButtonElement.href = adData.url_link || '#';
                adLinkElement.textContent = 'Buy Now';
            } catch (error) {
                console.error('Error fetching ad data:', error);
                // Handle the error as needed
                // For example, you could update an error message on the page
                // or display a fallback image for the ad
                const adImageElement = document.getElementById('adimage');
                adImageElement.src = '/path/to/fallback-image.jpg';  // Update with your actual path
            }
        }
        fetchAdData();

    }); -->


</body>
</html>